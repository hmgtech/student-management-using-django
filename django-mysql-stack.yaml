AWSTemplateFormatVersion: '2010-09-09'
Description: AWS CloudFormation template for Student Management Django app with MySQL in VPC, existing S3 bucket, and Secrets Manager

Resources:
  # VPC
  StudentManagementVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: StudentManagementVPC

  # Internet Gateway
  StudentManagementInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: StudentManagementInternetGateway

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref StudentManagementVPC
      InternetGatewayId: !Ref StudentManagementInternetGateway

  # Public Subnet
  PublicStudentSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref StudentManagementVPC
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [0, !GetAZs '']

  # Private Subnet 1
  PrivateStudentSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref StudentManagementVPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [0, !GetAZs '']

  # Private Subnet 2
  PrivateStudentSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref StudentManagementVPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Select [1, !GetAZs '']

  # Route Table for Public Subnet
  PublicStudentRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref StudentManagementVPC
      Tags:
        - Key: Name
          Value: PublicStudentRouteTable

  PublicStudentRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicStudentRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref StudentManagementInternetGateway

  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicStudentSubnet
      RouteTableId: !Ref PublicStudentRouteTable

  # NAT Gateway for Private Subnets
  StudentManagementNATGatewayEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  StudentManagementNATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt StudentManagementNATGatewayEIP.AllocationId
      SubnetId: !Ref PublicStudentSubnet

  # Route Table for Private Subnets
  PrivateStudentRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref StudentManagementVPC
      Tags:
        - Key: Name
          Value: PrivateStudentRouteTable

  PrivateStudentRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateStudentRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref StudentManagementNATGateway

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateStudentSubnet1
      RouteTableId: !Ref PrivateStudentRouteTable

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateStudentSubnet2
      RouteTableId: !Ref PrivateStudentRouteTable

  # Security Group for EC2 instance
  StudentManagementEC2SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH and HTTP
      VpcId: !Ref StudentManagementVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: StudentManagementEC2SecurityGroup

  # Security Group for RDS instance
  StudentManagementRDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow MySQL access from EC2
      VpcId: !Ref StudentManagementVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref StudentManagementEC2SecurityGroup
      Tags:
        - Key: Name
          Value: StudentManagementRDSSecurityGroup

  # EC2 instance
  StudentManagementEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.medium
      SecurityGroupIds:
        - !Ref StudentManagementEC2SecurityGroup
      SubnetId: !Ref PublicStudentSubnet
      ImageId: ami-04a81a99f5ec58529 # Ubuntu Server 22.04 LTS (64-bit x86)
      KeyName: my-key-pair
      Tags:
        - Key: Name
          Value: StudentManagementEC2Instance

  # RDS MySQL instance
  StudentManagementMySQLDB:
    Type: AWS::RDS::DBInstance
    Properties:
      DBName: "student"
      DBInstanceIdentifier: "studentdb"
      Engine: "mysql"
      EngineVersion: "8.0"
      DBInstanceClass: "db.t3.micro"
      AllocatedStorage: "20"
      MasterUsername: "admin"
      MasterUserPassword: "password"
      DBSubnetGroupName: !Ref StudentManagementDBSubnetGroup
      VPCSecurityGroups:
        - !Ref StudentManagementRDSSecurityGroup
      PubliclyAccessible: false
      MultiAZ: false
      BackupRetentionPeriod: 7
      StorageType: "gp2"
      Tags:
        - Key: Name
          Value: "StudentManagementMySQLDB"

  # RDS Subnet Group
  StudentManagementDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for RDS
      SubnetIds:
        - !Ref PrivateStudentSubnet1
        - !Ref PrivateStudentSubnet2
      DBSubnetGroupName: student-management-db-subnet-group

  # Secrets Manager Secret
  StudentManagementSecrets:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: student-management-secrets
      Description: Secrets for Student Management application
      SecretString: !Sub |
        {
          "DJANGO_SECRET_KEY": "your-django-secret-key",
          "DATABASE_NAME": "student",
          "DATABASE_USER": "admin",
          "DATABASE_PASSWORD": "password",
          "DATABASE_HOST": "${StudentManagementMySQLDB.Endpoint.Address}",
          "DATABASE_PORT": "3306",
          "AWS_ACCESS_KEY_ID": "",
          "AWS_SECRET_ACCESS_KEY": "",
          "AWS_SESSION_TOKEN": "",
          "AWS_STORAGE_BUCKET_NAME": "hitesh-student-management",
          "AWS_S3_REGION_NAME": "us-east-1",
          "AWS_S3_CUSTOM_DOMAIN": "hitesh-student-management.s3.amazonaws.com"
        }

# Outputs
Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref StudentManagementVPC
  PublicSubnetId:
    Description: Public Subnet ID
    Value: !Ref PublicStudentSubnet
  PrivateSubnet1Id:
    Description: Private Subnet 1 ID
    Value: !Ref PrivateStudentSubnet1
  PrivateSubnet2Id:
    Description: Private Subnet 2 ID
    Value: !Ref PrivateStudentSubnet2
  NATGatewayId:
    Description: NAT Gateway ID
    Value: !Ref StudentManagementNATGateway
  EC2InstanceId:
    Description: EC2 Instance ID
    Value: !Ref StudentManagementEC2Instance
  RDSInstanceId:
    Description: RDS Instance ID
    Value: !Ref StudentManagementMySQLDB
  RDSInstanceEndpoint:
    Description: RDS MySQL Endpoint
    Value: !GetAtt StudentManagementMySQLDB.Endpoint.Address
  S3BucketName:
    Description: S3 Bucket Name
    Value: "hitesh-student-management"
  SecretsManagerSecretArn:
    Description: Secrets Manager Secret ARN
    Value: !Ref StudentManagementSecrets
